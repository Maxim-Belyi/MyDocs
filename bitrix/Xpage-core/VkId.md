---
sidebar_position: 8
---

# `VkId`.
---
Это реализация авторизации через современный протокол **VK ID** (OAuth 2.1) для 1С-Битрикс.
### Основные методы класса `VkId`

| Функция | Что делает |
| :--- | :--- |
| **getAuthorizationLink** | Генерирует URL для перехода на страницу авторизации VK. Поддерживает выбор провайдера (VK, OK, Mail.ru) и темы оформления (светлая/темная). Использует PKCE для защиты. |
| **Authorize** | Обрабатывает ответ от VK. Получает токен, запрашивает данные профиля, сопоставляет их с пользователем Битрикс и выполняет вход на сайт. |
| **prepareUser** | Преобразует данные профиля VK (имя, телефон, почта, пол, аватар) в массив полей Битрикс. Ищет существующего пользователя для объединения аккаунтов. |
| **getAccessToken** | (private) Обменивает временный код на `access_token` через `https://id.vk.com/oauth2/auth`. |
| **getUserInfo** | (private) Запрашивает детальную информацию о пользователе через `https://id.vk.com/oauth2/user_info`. |

---

## Особенности реализации

1.  **Мультипровайдерность:**
Метод `getAuthorizationLink` через параметр `$provider` позволяет использовать одну и ту же логику для входа через **VK ID**, **Одноклассники (ok_ru)** или **Mail.ru**, так как они теперь работают через единую экосистему VK.

2.  **Безопасность (PKCE):**
Реализована поддержка **PKCE (Proof Key for Code Exchange)**. Генерируется `code_challenge`, который проверяется на стороне VK. Это предотвращает перехват кода авторизации злоумышленниками.

3.  **Связывание аккаунтов и дедупликация:**
Класс содержит продвинутую логику поиска существующего пользователя:
*   Поиск ведется одновременно по **Email** и по **номеру телефона**.
*   Интеграция с `YaId`: при проверке почты учитываются возможные алиасы (псевдонимы) почтовых доменов Яндекса.
*   Если пользователь найден, система автоматически авторизует его и **дозаполняет** пустые поля профиля (например, устанавливает фото или дату рождения, если их не было).

4.  **Обработка аватаров:**
Автоматически скачивает аватар пользователя по прямой ссылке и регистрирует его в системе Битрикс через `CFile::MakeFileArray`.

---

## Инструкция по использованию

#### 1. Генерация ссылки для входа
В шаблоне компонента или на странице авторизации:
```php
use Xpage\Core\Service\Authentication\VkId;

// Параметры: провайдер (vkid/ok_ru/mail_ru), тема (light/dark), куда вернуть пользователя
$loginUrl = VkId::getAuthorizationLink(
provider: 'vkid',
scheme: 'dark',
backUrl: '/personal/'
);
?>
<a href="<?= $loginUrl ?>">Войти через VK ID</a>
```

#### 2. Настройка Redirect URI
В кабинете разработчика VK (VK Cloud / VK ID) в качестве доверенного Redirect URI необходимо указать:
`https://ваш-сайт.ru/api-internal/auth/vkid/` (точный путь зависит от настроек вашего роутинга в Битриксе).

#### 3. Настройки модуля
В настройках модуля `xpage.core` должны быть заполнены:
*   `auth_vk_app_id` — ID приложения.
*   `auth_vk_protected_key` — Защищенный ключ.
*   `auth_vk_service_key` — Сервисный ключ доступа.

---

## Примечание по ошибкам
Если авторизация не удалась, метод `Authorize` выполнит редирект на главную страницу с параметром `?error=...`. Тексты ошибок берутся из перечисления (Enum) `AuthenticationError`. Все технические подробности ошибок API записываются в системный журнал Битрикса (`CEventLog`).