---
sidebar_position: 5
---

# Класс `ReCaptcha.php` 

реализует интеграцию с сервисом **Google ReCaptcha v3**.


## Основные методы класса `ReCaptcha`

| Функция | Что делает |
| :--- | :--- |
| **validateToken** | Главный метод проверки. Принимает токен с фронтенда и сравнивает полученный от Google балл с минимально допустимым порогом. |
| **getSiteKey** | Возвращает публичный ключ (Site Key) из настроек модуля для инициализации капчи на фронтенде. |
| **isReCaptchaDisabled** | Проверяет, нужно ли вообще проводить проверку. Учитывает общие настройки модуля и режим «отключить на локальной разработке». |
| **isValidReCaptchaResult** | (private) Содержит логику проверки. Сначала ищет результат в сессии (чтобы не делать лишних запросов к Google), а если его нет — вызывает API Google. |
| **sendRequest** | (private) Выполняет прямой CURL-запрос к серверу Google (`recaptcha/api/siteverify`). |

---

## Особенности реализации

1.  **Оптимизация запросов (Session Cache):**
    Класс умеет кэшировать результат успешной проверки в сессию пользователя (`recaptcha_result`).
    *   Если пользователь уже прошел проверку на одной форме, при отправке другой формы в рамках того же хита/сессии запрос к Google не повторится (если включена опция `captcha_save_verification_result`). Это экономит время ответа сервера и лимиты API.

2.  **Порог чувствительности (Score):**
    В методе `validateToken` можно передать желаемый порог `$score`. Если он не передан, используется значение по умолчанию из настроек модуля (`recaptcha_default_score`), обычно это `0.5`.

3.  **Гибкость окружения:**
    Метод `isReCaptchaDisabled` автоматически определяет локальную среду разработки (через `Helper::isLocalDeployment`). Если в настройках стоит галочка «Отключать на локалке», капча всегда будет возвращать `true`, что избавляет разработчиков от проблем с валидацией на `localhost`.

4.  **Обработка исключений:**
    Метод не просто возвращает `false`, а выбрасывает `Exception` с локализованным сообщением об ошибке. Это позволяет удобно перехватывать ошибки в контроллерах и отдавать их фронтенду.

---

## Инструкция по использованию

#### 1. Использование в контроллере (API)
```php
use Xpage\Core\Service\Security\ReCaptcha;

try {
    $token = $this->getRequest()->getPost('g-recaptcha-response');
    
    // Проверка с порогом 0.7 (более строгая)
    ReCaptcha::validateToken($token, 0.7);
    
    // Если код прошел сюда — проверка успешна
} catch (\Exception $e) {
    // Ошибка валидации: токен пустой или Google считает пользователя ботом
    return ['error' => $e->getMessage()];
}
```

#### 2. Настройки в админке
В настройках модуля `xpage.core` необходимо заполнить:
*   `recaptcha_site_key` — Публичный ключ.
*   `recaptcha_secret_key` — Секретный ключ.
*   `recaptcha_default_score` — Значение от 0.1 до 0.9 (рекомендуется 0.5).
*   `captcha_active` — Общий рубильник активности.
*   `captcha_inactive_local` — Отключать ли проверку на тестовых стендах.

---

### Примечание 
Токен должен передаваться в параметре запроса `g-recaptcha-response`. Если ваш фронт использует другой заголовок (например, `X-ReCaptcha-Token`), его нужно извлечь и передать в метод `validateToken` вручную.