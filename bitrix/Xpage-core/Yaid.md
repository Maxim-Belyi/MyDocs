---
sidebar_position: 10
---

# `YaId.php`  
---
 реализует авторизацию через **Yandex ID** (OAuth 2.0) для сайта на 1С-Битрикс. Он интегрируется в стандартную систему социальных сервисов Битрикса, но расширяет её специфической логикой Xpage (обработка псевдонимов почты, объединение профилей, PKCE-авторизация).


## Основные методы класса `YaId`

| Функция | Что делает |
| :--- | :--- |
| **getAuthorizationLink** | Генерирует URL для перехода на страницу авторизации Яндекса. Использует протокол PKCE (создает `code_challenge`) для безопасности. |
| **Authorize** | Основной метод-обработчик. Вызывается после того, как Яндекс вернул пользователя на сайт. Получает токен, запрашивает данные профиля и авторизует пользователя в Битриксе. |
| **prepareUser** | Преобразует данные от Яндекса (имя, пол, фото, почта) в массив полей пользователя Битрикс. Содержит логику поиска существующего пользователя по Email или телефону. |
| **isYandexEmail** | Проверяет, принадлежит ли указанный Email к доменам Яндекса (yandex.ru, ya.ru и т.д.). |
| **getEmailAliasesByLogin** | Возвращает массив всех возможных вариантов почты для одного логина (например, `user@yandex.ru`, `user@ya.ru` и др.). |
| **getAccessToken** | (private) Обменивает временный `code` на постоянный `access_token` через API Яндекса. |
| **getUserInfo** | (private) Делает запрос к API Яндекса для получения детальной информации о пользователе (имя, почта, телефон, аватар). |

---

## Особенности реализации (Важно для разработки)

1.  **Безопасность (PKCE):**
    Класс использует механизм `code_challenge` и `code_verifier`. При генерации ссылки создается уникальный код, который сохраняется в сессии (`ya_id_nonce`), а при получении токена Яндекс проверяет его. Это защищает от перехвата кода авторизации.

2.  **Умное объединение аккаунтов:**
    Если пользователь авторизуется через Яндекс, и в базе сайта уже есть человек с такой же почтой или телефоном:
    *   Сайт **не создает дубликат**.
    *   Сайт авторизует существующего пользователя.
    *   Дозаполняет пустые поля (например, если не было фото или даты рождения, они подтянутся из Яндекса).

3.  **Обработка аватаров:**
    Метод автоматически скачивает аватар пользователя из Яндекса, определяет его тип (png, jpg, webp) и корректно регистрирует файл в структуре Битрикса (`CFile::MakeFileArray`).

4.  **Логирование ошибок:**
    Все неудачные попытки входа (ошибки API, таймауты) записываются в **Журнал событий Битрикса** (`CEventLog`) с идентификатором `YAID`.

---

## Как использовать (Пример)

#### 1. Получение ссылки для кнопки "Войти через Яндекс"
В шаблоне компонента авторизации:
```php
use Xpage\Core\Service\Authentication\YaId;

$loginUrl = YaId::getAuthorizationLink(backUrl: '/personal/');
?>
<a href="<?= $loginUrl ?>" class="btn-yandex">Войти через Яндекс ID</a>
```

#### 2. Обработка ответа (Callback)
Обычно роут `xpage_core_auth_ya_id` ведет на контроллер, который делает следующее:
```php
$code = $request->get('code');
if ($code) {
    $authService = new \Xpage\Core\Service\Authentication\YaId($code);
    $authService->Authorize(); // Метод сам сделает редирект при успехе или ошибке
}
```

## Настройки модуля
Для работы метода необходимо, чтобы в настройках модуля `xpage.core` были заполнены:
*   `auth_ya_client_id` — ID приложения из Яндекс ID.
*   `auth_ya_client_secret` — Пароль приложения.

**Важно:** В консоли разработчика Яндекса в качестве Redirect URI нужно указать URL, который возвращает метод `self::getRedirectUrl()` (обычно это `/api-internal/auth/yaid/`).