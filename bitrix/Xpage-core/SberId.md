---
sidebar_position: 6
---

# Класс `SberId.php`

реализует интеграцию с **Sber ID** (СберБизнес / Сбер ID) по протоколу OpenID Connect (OIDC). Это наиболее сложная реализация среди всех ID-сервисов в модуле, так как Сбер требует использования **SSL-сертификатов** для каждого запроса и обязательной отправки аналитики.


### Основные методы класса `SberId`

| Функция | Что делает |
| :--- | :--- |
| **getAuthorizationLink** | Генерирует ссылку для перехода на страницу входа Сбера. Создает уникальный `nonce` для защиты от атак повторного воспроизведения и поддерживает `login_hint` (предустановка телефона). |
| **Authorize** | Обрабатывает возврат пользователя. Сначала пытается найти пользователя по `XML_ID` (если он уже входил через Сбер ранее), если не находит — запрашивает данные профиля, создает/объединяет аккаунт и отправляет аналитику в Сбер. |
| **getAccessToken** | Обменивает код на токен. **Важно:** Внутри происходит расшифровка и валидация JWT (ID Token): проверяются `nonce`, `aud` (client_id) и `sub` (уникальный ID Сбера). |
| **getUserInfo** | Запрашивает расширенные данные пользователя (ФИО, почта, телефон) через API Сбера. |
| **gateway** | (private) Универсальный метод для выполнения CURL-запросов. В отличие от других провайдеров, здесь принудительно используется **SSL-сертификат** (`.crt` / `.pem`), путь к которому задается в настройках. |
| **sendAnalytics** | Обязательный метод Сбера. Уведомляет API Сбера о том, что авторизация на стороне сайта успешно завершена. |
| **prepareUser** | Нормализует данные: приводит ФИО к формату "Title Case" (Иван Иванович Иванов), очищает телефон от лишних символов и ищет совпадения в базе для объединения профилей. |

---

### Технические особенности (Важно для администрирования)

1.  **SSL Сертификаты:**
    Для работы со Сбером недостаточно просто Client ID и Secret. Нужно получить сертификаты в кабинете разработчика Сбера и прописать путь к файлу сертификата в настройках модуля (`auth_sber_certificate_path`). Без него запросы будут отклонены.

2.  **Защита и валидация:**
    *   Используется `RquId` — уникальный UUID для каждого запроса к Сберу.
    *   Происходит жесткая проверка `ID Token`. Если `nonce` в ответе не совпадает с тем, что был отправлен, или если `aud` (аудитория) не принадлежит вашему приложению, авторизация будет прервана по соображениям безопасности.

3.  **Умный поиск (Дедупликация):**
    Как и в других сервисах Xpage, если Сбер вернул почту `ivan@yandex.ru`, а на сайте уже есть `ivan@ya.ru`, система поймет, что это один и тот же человек (через логику `YaId::isYandexEmail`) и предложит объединить профили вместо создания нового.

4.  **Аналитика:**
    Сбер требует вызова эндпоинта `/auth/completed`. Если его не вызвать, статистика в кабинете Сбера может отображаться некорректно, а интеграция может считаться незавершенной.

---

## Инструкция по использованию

#### 1. Вывод ссылки на вход
```php
use Xpage\Core\Service\Authentication\SberId;

// Можно передать номер телефона пользователя, если он уже известен (login_hint)
$loginUrl = SberId::getAuthorizationLink(phone: '79991234567', backUrl: '/');
?>
<a href="<?= $loginUrl ?>" class="sber-id-button">Войти по Сбер ID</a>
```

#### 2. Настройки в админке
В настройках модуля `xpage.core` должны быть заполнены:
*   `auth_sber_client_id` — выданный Сбером ID.
*   `auth_sber_client_secret` — секретный ключ.
*   `auth_sber_certificate_path` — **абсолютный путь** на сервере к файлу сертификата (например, `/var/www/certs/sber.pem`).

#### 3. Redirect URI
В консоли Сбера укажите:
`https://ваш-сайт.ru/api-internal/auth/sberid/`

### Резюме по ошибкам
Класс обрабатывает ошибки через `CEventLog`. Если авторизация не проходит, проверьте лог (Audit Type: `USER_LOGIN`, Item ID: `SBERID`). Чаще всего ошибки связаны с неверным путем к сертификату или его истекшим сроком действия.