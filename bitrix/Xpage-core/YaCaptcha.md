---
sidebar_position: 9
---

# `YaCaptcha.php`
реализует интеграцию с сервисом **Yandex SmartCaptcha**.

## Основные методы класса `YaCaptcha`

| Функция | Что делает |
| :--- | :--- |
| **validateToken** | Основной метод проверки. Принимает токен от фронтенда и IP пользователя. Если проверка не пройдена, выбрасывает исключение `Exception`. |
| **getClientKey** | Возвращает «Ключ клиента» (Client Key) из настроек модуля для инициализации капчи в JS-коде. |
| **isYaCaptchaDisabled** | Проверяет, активна ли капча. Учитывает настройки модуля (поле `captcha_active`) и флаг отключения на локальной разработке. |
| **isValidYaCaptchaResult** | (private) Содержит логику валидации. Проверяет наличие успешного результата в сессии (кэш), а если его нет — инициирует запрос к серверам Яндекса. |
| **sendRequest** | (private) Выполняет POST-запрос к API Яндекса (`smartcaptcha.cloud.yandex.ru/validate`). |

---

## Особенности реализации

1.  **Отказоустойчивость (Fail-safe):**
    В методе `sendRequest` реализована важная рекомендация Яндекса: если сервер капчи вернул HTTP-код, отличный от 200, или запрос отвалился по таймауту (установлен жесткий лимит в 1 секунду), система **автоматически считает проверку успешной** (`status: ok`). Это гарантирует, что ваши пользователи не пострадают, если сервис Яндекса будет временно недоступен.

2.  **Кэширование в сессии:**
    Если в настройках включена опция `yacaptcha_save_verification_result`, результат успешной проверки сохраняется в сессию пользователя. При повторной отправке формы (или отправке другой формы в рамках того же сеанса) запрос к API Яндекса не выполняется, что ускоряет работу сайта.

3.  **Автоматическое определение IP:**
    Для валидации Яндексу нужен IP пользователя. Если он не передан в метод вручную, класс сам получит его через встроенный в Битрикс менеджер `GeoIp\Manager::getRealIp()`.

4.  **Удобство разработки:**
    Капча легко отключается для локальных сред (через флаг `captcha_inactive_local` в настройках), чтобы не блокировать работу программистов на тестовых доменах.

---

## Инструкция по использованию

#### 1. Проверка в контроллере (API)
```php
use Xpage\Core\Service\Security\YaCaptcha;

try {
    // Токен обычно приходит в заголовке X-YaCaptcha-Token или параметре запроса
    $token = $request->getPost('smart-token');
    
    YaCaptcha::validateToken($token);
    
    // Если код дошел сюда — проверка пройдена успешно
} catch (\Exception $e) {
    // Ошибка: токен невалиден или отсутствует
    return ['error' => $e->getMessage()];
}
```

#### 2. Настройки в админке
Для работы модуля необходимо заполнить настройки (раздел «Настройки модуля xpage.core»):
*   `yacaptcha_client_key` — Ключ клиента (для фронтенда).
*   `yacaptcha_server_key` — Ключ сервера (для бэкенд-валидации).
*   `captcha_active` — Установить в `Y`.
*   `yacaptcha_save_verification_result` — Рекомендуется `Y` для экономии ресурсов.

---

## Примечание по безопасности
Токен Яндекса одноразовый и имеет короткий срок жизни. Рекомендуется выполнять `validateToken` как можно раньше при обработке входящего запроса от пользователя. Класс использует `curl` с коротким таймаутом, чтобы проверка не замедляла работу вашего приложения в случае сетевых задержек.